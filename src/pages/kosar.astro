---
import Layout from '../layouts/Layout.astro';
import BreadcrumbNav from '../components/BreadcrumbNav.astro';
import OrderNotice from '../components/OrderNotice.astro';
---

<Layout title="Kosar | Trapezlemezes.hu" noindex>
  <div class="cart-page">
    <div class="container">
      <BreadcrumbNav items={[{ label: 'Kosar' }]} />

      <h1>Kosar</h1>

      <div id="cart-container">
        <!-- Client-side rendered cart content -->
        <div class="cart-loading">
          <p>Kosar betoltese...</p>
        </div>
      </div>

      <OrderNotice compact />
    </div>
  </div>
</Layout>

<style>
  .cart-page {
    padding: var(--spacing-lg) 0 var(--spacing-3xl);
    background: var(--color-bg-light);
    min-height: calc(100vh - 200px);
  }

  h1 {
    font-size: var(--font-size-3xl);
    margin-bottom: var(--spacing-lg);
    color: var(--color-text);
  }

  .cart-loading {
    text-align: center;
    padding: var(--spacing-2xl);
    color: var(--color-text-muted);
  }

  /* Cart items list */
  :global(.cart-items) {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
  }

  :global(.cart-item) {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: var(--spacing-lg);
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: var(--spacing-md);
    align-items: center;
  }

  @media (max-width: 768px) {
    :global(.cart-item) {
      grid-template-columns: 1fr;
      gap: var(--spacing-sm);
    }
  }

  :global(.cart-item-info) {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  :global(.cart-item-color) {
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--color-text);
  }

  :global(.cart-item-details) {
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  :global(.cart-item-sqm) {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  :global(.sqm-input) {
    width: 80px;
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    text-align: center;
  }

  :global(.sqm-input:focus) {
    outline: none;
    border-color: var(--color-secondary);
  }

  :global(.cart-item-price) {
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--color-text);
    text-align: right;
    white-space: nowrap;
  }

  :global(.cart-item-remove) {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.cart-item-remove:hover) {
    color: var(--color-accent);
    background: #fef2f2;
  }

  /* Shipping selector */
  :global(.shipping-section) {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }

  :global(.shipping-section h2) {
    font-size: var(--font-size-xl);
    margin-bottom: var(--spacing-md);
  }

  :global(.shipping-options) {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  :global(.shipping-option) {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  :global(.shipping-option:hover) {
    border-color: var(--color-secondary);
  }

  :global(.shipping-option.selected) {
    border-color: var(--color-secondary);
    background: #e3f2fd;
  }

  :global(.shipping-option input[type="radio"]) {
    accent-color: var(--color-secondary);
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  :global(.shipping-option-content) {
    flex: 1;
  }

  :global(.shipping-option-name) {
    font-weight: 600;
    color: var(--color-text);
  }

  :global(.shipping-option-desc) {
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
    margin-top: 2px;
  }

  :global(.shipping-option-price) {
    font-weight: 700;
    color: var(--color-text);
    white-space: nowrap;
  }

  /* Summary */
  :global(.cart-summary) {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }

  :global(.cart-summary h2) {
    font-size: var(--font-size-xl);
    margin-bottom: var(--spacing-md);
  }

  :global(.summary-row) {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--color-bg-light);
  }

  :global(.summary-row:last-of-type) {
    border-bottom: none;
  }

  :global(.summary-label) {
    color: var(--color-text-light);
  }

  :global(.summary-value) {
    font-weight: 600;
    color: var(--color-text);
  }

  :global(.summary-total) {
    display: flex;
    justify-content: space-between;
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-sm);
    border-top: 2px solid var(--color-text);
  }

  :global(.summary-total .summary-label) {
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--color-text);
  }

  :global(.summary-total .summary-value) {
    font-weight: 700;
    font-size: var(--font-size-xl);
    color: var(--color-secondary);
  }

  /* Actions */
  :global(.cart-actions) {
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
    flex-wrap: wrap;
  }

  :global(.btn-checkout) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-xl);
    background: var(--color-primary);
    color: var(--color-white);
    font-weight: 700;
    font-size: var(--font-size-lg);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  :global(.btn-checkout:hover) {
    background: var(--color-primary-dark);
    color: var(--color-white);
  }

  :global(.btn-continue) {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    background: transparent;
    border: 2px solid var(--color-border);
    color: var(--color-text);
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  :global(.btn-continue:hover) {
    border-color: var(--color-text);
    color: var(--color-text);
  }

  /* Empty cart */
  :global(.cart-empty) {
    text-align: center;
    padding: var(--spacing-3xl) var(--spacing-lg);
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  :global(.cart-empty-icon) {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  :global(.cart-empty h2) {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--spacing-md);
  }

  :global(.cart-empty p) {
    color: var(--color-text-light);
    margin-bottom: var(--spacing-lg);
    font-size: var(--font-size-lg);
  }

  :global(.cart-empty-links) {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
  }

  :global(.cart-empty-links a) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md) var(--spacing-xl);
    border-radius: var(--radius-md);
    font-weight: 600;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  :global(.link-calculator) {
    background: var(--color-primary);
    color: var(--color-white) !important;
  }

  :global(.link-calculator:hover) {
    background: var(--color-primary-dark);
    color: var(--color-white) !important;
  }

  :global(.link-products) {
    background: transparent;
    border: 2px solid var(--color-primary);
    color: var(--color-primary) !important;
  }

  :global(.link-products:hover) {
    background: var(--color-primary);
    color: var(--color-white) !important;
  }
</style>

<script>
  import { getCartSummary, removeFromCart, updateCartItemSqm, setShippingType, formatPrice, getShippingType } from '../lib/cart';
  import { shippingPrices, freeShippingSqmThreshold } from '../calculator/calculation';

  const container = document.getElementById('cart-container');
  if (!container) throw new Error('cart-container not found');

  function renderCart() {
    const summary = getCartSummary();

    if (summary.items.length === 0) {
      container.innerHTML = `
        <div class="cart-empty">
          <div class="cart-empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"/>
              <circle cx="20" cy="21" r="1"/>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
          </div>
          <h2>A kosara ures</h2>
          <p>Meg nem adott hozza termekat a kosarhoz.</p>
          <div class="cart-empty-links">
            <a href="/kalkulator" class="link-calculator">Kalkulator</a>
            <a href="/trapezlemez-arak" class="link-products">Trapezlemez arak</a>
          </div>
        </div>
      `;
      return;
    }

    const shippingType = getShippingType();

    const itemsHtml = summary.items.map(item => `
      <div class="cart-item" data-id="${item.id}">
        <div class="cart-item-info">
          <span class="cart-item-color">${item.colorLabel}</span>
          <span class="cart-item-details">
            ${item.pricePerSqm ? formatPrice(item.pricePerSqm) + '/m²' : ''}
            ${item.withScrews ? ' + csavar' : ''}
            ${item.source === 'calculator' ? ' (kalkulator)' : ''}
          </span>
        </div>
        <div class="cart-item-sqm">
          <input
            type="number"
            class="sqm-input"
            value="${item.sqm}"
            min="1"
            step="0.1"
            data-id="${item.id}"
            aria-label="Terulet m²-ben"
            ${item.source === 'calculator' ? 'readonly title="Kalkulator altal szamitott terulet"' : ''}
          />
          <span>m²</span>
        </div>
        <div class="cart-item-price">
          ${formatPrice(item.totalPrice + item.screwCost)}
        </div>
        <button class="cart-item-remove" data-id="${item.id}" aria-label="Tetel eltavolitasa" title="Torles">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
        </button>
      </div>
    `).join('');

    const shippingOptions = [
      {
        value: 'gazdasagos',
        name: 'Gazdasagos szallitas',
        desc: '3-5 munkanap',
        price: summary.totalSqm >= freeShippingSqmThreshold ? 'Ingyenes' : formatPrice(shippingPrices.economy),
      },
      {
        value: 'expressz',
        name: 'Expressz szallitas',
        desc: '1-2 munkanap',
        price: summary.totalSqm >= freeShippingSqmThreshold ? 'Ingyenes' : formatPrice(shippingPrices.express),
      },
      {
        value: 'sajat',
        name: 'Szemelyes atvetel',
        desc: 'Atvetel a telephelyunkon',
        price: 'Ingyenes',
      },
    ];

    const shippingHtml = shippingOptions.map(opt => `
      <label class="shipping-option ${shippingType === opt.value ? 'selected' : ''}">
        <input
          type="radio"
          name="shipping"
          value="${opt.value}"
          ${shippingType === opt.value ? 'checked' : ''}
        />
        <div class="shipping-option-content">
          <div class="shipping-option-name">${opt.name}</div>
          <div class="shipping-option-desc">${opt.desc}</div>
        </div>
        <div class="shipping-option-price">${opt.price}</div>
      </label>
    `).join('');

    container.innerHTML = `
      <div class="cart-items">
        ${itemsHtml}
      </div>

      <div class="shipping-section">
        <h2>Szallitasi mod</h2>
        <div class="shipping-options">
          ${shippingHtml}
        </div>
      </div>

      <div class="cart-summary">
        <h2>Osszesites</h2>
        <div class="summary-row">
          <span class="summary-label">Lemezek (${summary.totalSqm} m²)</span>
          <span class="summary-value">${formatPrice(summary.sheetSubtotal)}</span>
        </div>
        ${summary.screwTotal > 0 ? `
          <div class="summary-row">
            <span class="summary-label">Csavarok</span>
            <span class="summary-value">${formatPrice(summary.screwTotal)}</span>
          </div>
        ` : ''}
        <div class="summary-row">
          <span class="summary-label">Szallitas</span>
          <span class="summary-value">${summary.shippingCost === 0 ? 'Ingyenes' : formatPrice(summary.shippingCost)}</span>
        </div>
        <div class="summary-total">
          <span class="summary-label">Vegosszeg</span>
          <span class="summary-value">${formatPrice(summary.grandTotal)}</span>
        </div>
      </div>

      <div class="cart-actions">
        <a href="/megrendeles" class="btn-checkout">Tovabb a megrendeleshez</a>
        <a href="/trapezlemez-arak" class="btn-continue">Vasarlas folytatas</a>
      </div>
    `;

    bindEvents();
  }

  function bindEvents() {
    // Remove buttons
    container.querySelectorAll('.cart-item-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const id = target.dataset.id;
        if (id) {
          removeFromCart(id);
          renderCart();
        }
      });
    });

    // Sqm inputs
    container.querySelectorAll('.sqm-input').forEach(input => {
      if ((input as HTMLInputElement).readOnly) return;
      input.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const id = target.dataset.id;
        const sqm = parseFloat(target.value);
        if (id && sqm > 0) {
          updateCartItemSqm(id, sqm);
          renderCart();
        }
      });
    });

    // Shipping radio buttons
    container.querySelectorAll('input[name="shipping"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        setShippingType(target.value as 'gazdasagos' | 'expressz' | 'sajat');
        renderCart();
      });
    });
  }

  // Initial render
  renderCart();

  // Listen for cart updates from other tabs/components
  window.addEventListener('cart:updated', renderCart);
</script>
