---
import Layout from '../../layouts/Layout.astro';
import BreadcrumbNav from '../../components/BreadcrumbNav.astro';
import ComparisonTable from '../../components/ComparisonTable.astro';
import StrengthChart from '../../components/StrengthChart.astro';
import ExperienceBlock from '../../components/ExperienceBlock.astro';
import TrustSignals from '../../components/TrustSignals.astro';
import CtaBox from '../../components/CtaBox.astro';
import ProductCard from '../../components/ProductCard.astro';

import { colors } from '../../calculator/config';
import { basePrices } from '../../calculator/calculation';
import { getFaqSchema } from '../../config/schema';

// Product images
import antracitImg from '../../assets/images/antracit-trapezlemez.jpg';
import barnaImg from '../../assets/images/barna-trapezlemez.jpg';
import vorosImg from '../../assets/images/voros-trapezlemez.jpg';
import kekImg from '../../assets/images/kek-trapezlemez.jpg';
import feherImg from '../../assets/images/feher-trapezlemez.jpg';
import feketeImg from '../../assets/images/fekete-trapezlemez.jpg';
import narancsImg from '../../assets/images/narancssarga-trapezlemez.jpg';
import famintasImg from '../../assets/images/famintas-trapezlemez.jpg';
import horganyzottImg from '../../assets/images/horganyzott-natur-trapezlemez.jpg';

const imageMap: Record<string, ImageMetadata> = {
  antracit: antracitImg,
  barna: barnaImg,
  voros: vorosImg,
  kek: kekImg,
  feher: feherImg,
  fekete: feketeImg,
  narancs: narancsImg,
  famintas: famintasImg,
  horganyzott: horganyzottImg,
};

const availableColors = colors.filter(c => c.available && imageMap[c.id]);

// FAQ data
const faqs = [
  {
    question: 'Milyen vastag a lemez?',
    answer: 'Alap kínálatunkban 0.5mm vastagságú T18 lemezek vannak – ez erősebb, mint a piacon szokásos 0.4mm. Időszakosan 0.6mm svéd acél lemezt is kínálunk, a 0.4mm áráért.',
  },
  {
    question: 'Mennyi idő a gyártás?',
    answer: 'Raktári anyagból 48 órán belül gyártunk. Egyedi színeknél ez eltérhet.',
  },
  {
    question: 'Milyen garanciát adnak?',
    answer: '20 év garanciát vállalunk minden lemezünkre. Ez szinte példa nélküli az iparágban.',
  },
  {
    question: 'Hogyan működik a rendelés?',
    answer: 'Válasszon színt, adja meg a négyzetmétert, tegye kosárba. A kosárban leadhatja szándéknyilatkozatát, majd 24 órán belül felhívjuk és véglegesítjük a részleteket.',
  },
  {
    question: 'Mennyibe kerül a szállítás?',
    answer: 'Gazdaságos: 19 990 Ft, Expressz: 39 990 Ft. 250 m² felett ingyenes! Önköltségi áron szállítunk.',
  },
  {
    question: 'Lehet személyesen átvenni?',
    answer: 'Igen, telephelyünkön (1182 Budapest, Királyhágó utca 30.) személyesen is átveheti a megrendelését.',
  },
];

const faqSchema = getFaqSchema(faqs);

// Comparison rows - T12 0.4mm = 100% (baseline)
const comparisonRows = [
  { label: 'Vastagság', competitor: '0.4mm', ours: '0.5mm', highlight: true },
  { label: 'Hajlítási ellenállás', competitor: '0.072 kNm/m', ours: '0.135 kNm/m', highlight: true },
  { label: 'Erősség (T12 0.4mm = 100%)', competitor: '111%', ours: '208%', highlight: true },
  { label: 'Max alátámasztási táv', competitor: '80cm', ours: '100cm' },
  { label: 'Szelemenek (6m tetőre)', competitor: '8 db', ours: '6 db' },
  { label: 'Ár', competitor: '~2600 Ft/m²', ours: '2640 Ft/m²' },
  { label: 'Garancia', competitor: '5-10 év', ours: '20 év' },
  { label: 'Gyártás', competitor: '1-3 hét', ours: '48 óra' },
];
---

<Layout
  title="Trapézlemez | T18 0.5mm gyártótól – Erősebb, olcsóbb | Trapezlemezes.hu"
  description="Trapézlemez közvetlenül a gyártótól. T18 0.5mm – erősebb, mint máshol a 0.4mm. 48 óra gyártás, 20 év garancia. Online árkalkulátor."
  noindex={false}
  extraSchema={faqSchema}
>
  <div class="container">
    <BreadcrumbNav items={[{ label: 'Trapézlemez' }]} />
  </div>

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <div class="hero-content">
        <h1>Trapézlemez gyártótól – 0.5mm a 0.4mm áráért</h1>
        <p class="hero-subtitle">
          T18 profilú trapézlemez közvetlenül a gyártótól. Erősebb, mint a versenytársak vékonyabb lemezei – mégsem drágább.
        </p>
        <div class="hero-ctas">
          <a href="#szinek" class="btn btn-primary btn-lg">Színek és árak</a>
          <a href="/kalkulator" class="btn btn-accent btn-lg">Online árkalkulátor</a>
        </div>
      </div>
    </div>
  </section>

  <!-- USP Strip -->
  <section class="usp-strip">
    <div class="container">
      <div class="usp-grid">
        <div class="usp-item">
          <span class="usp-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </span>
          <div class="usp-text">
            <strong>0.5mm vastagság</strong>
            <span>Erősebb, mint máshol a 0.4mm</span>
          </div>
        </div>
        <div class="usp-item">
          <span class="usp-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </span>
          <div class="usp-text">
            <strong>48 óra gyártás</strong>
            <span>Raktári anyagból</span>
          </div>
        </div>
        <div class="usp-item">
          <span class="usp-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </span>
          <div class="usp-text">
            <strong>20 év garancia</strong>
            <span>Példa nélküli az iparágban</span>
          </div>
        </div>
        <div class="usp-item">
          <span class="usp-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </span>
          <div class="usp-text">
            <strong>Online kalkulátor</strong>
            <span>Azonnali ár, nem kell telefonálni</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 0.6mm highlight banner -->
  <section class="promo-banner">
    <div class="container">
      <div class="promo-inner">
        <div class="promo-badge">Akció</div>
        <div class="promo-content">
          <strong>0.6mm svéd acél – a 0.4mm áráért!</strong>
          <span>Időszakosan 0.6mm vastagságú svéd acél lemezeket kínálunk, a standard 0.5mm-es ár alatt. 3,5x erősebb, mint a piacon szokásos 0.4mm. Érdeklődjön telefonon: <a href="tel:+3613009206">+36 1 300-92-06</a></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Product Color Grid -->
  <section class="section section--tight" id="szinek">
    <div class="container">
      <h2>Válasszon színt és rendeljen</h2>
      <p class="section-subtitle">Adja meg a szükséges négyzetmétert, és tegye kosárba. A kosárba gomb megnyomása után csavart is hozzáadhat.</p>
      <div class="product-grid">
        {availableColors.map((color) => {
          const price = basePrices[color.type] || basePrices.standard;
          return (
            <ProductCard
              colorId={color.id}
              colorLabel={color.label}
              ral={color.ral}
              imageSrc={imageMap[color.id]}
              pricePerSqm={price}
              colorType={color.type}
              available={color.available}
              badge={color.type === 'promo' ? 'Akciós' : undefined}
            />
          );
        })}
      </div>
    </div>
  </section>

  <!-- Screw Upsell Modal (hidden by default) -->
  <div class="screw-modal-overlay" id="screw-modal" style="display: none;">
    <div class="screw-modal">
      <button class="screw-modal-close" id="screw-modal-close" aria-label="Bezárás">&times;</button>
      <h3 class="screw-modal-title">Kér csavart is?</h3>
      <p class="screw-modal-desc">EPDM gumis alátétes tetőcsavar – tökéletesen illik a trapézlemezhez.</p>
      <div class="screw-calc">
        <div class="screw-info">
          <span class="screw-recommendation" id="screw-recommendation"></span>
          <span class="screw-price-info">5 990 Ft / doboz (250 db, ~25 m²-hez)</span>
        </div>
        <div class="screw-controls">
          <button class="screw-btn" id="screw-minus" type="button">-</button>
          <span class="screw-count" id="screw-count">0</span>
          <span class="screw-unit">doboz</span>
          <button class="screw-btn" id="screw-plus" type="button">+</button>
        </div>
        <div class="screw-total" id="screw-total"></div>
      </div>
      <div class="screw-modal-actions">
        <button class="btn btn-primary" id="screw-add-btn">Hozzáadás csavarral</button>
        <button class="btn btn-outline" id="screw-skip-btn">Nem kérek csavart</button>
      </div>
    </div>
  </div>

  <!-- Calculator CTA -->
  <section class="section section--tight section--alt">
    <div class="container">
      <div class="calculator-cta-box">
        <h2>Pontosabb számítás kell?</h2>
        <p>Kalkulátorunkban megadhatja a pontos méreteket, tetőtípust, és darabra pontos árat kap.</p>
        <a href="/kalkulator" class="btn btn-primary btn-lg">Online árkalkulátor</a>
      </div>
    </div>
  </section>

  <!-- Strength Explanation + Chart -->
  <section class="section section--tight" id="osszehasonlitas">
    <div class="container">
      <h2>Miért erősebb a T18 0.5mm?</h2>

      <div class="strength-explainer">
        <div class="explainer-physics">
          <h3>A fizika: vastagság harmadik hatványon</h3>
          <p>
            A lemez hajlítási ellenállása (teherbírása) a vastagság <strong>köbével</strong> arányos: <code>W = b × t³ / 6</code>.
            Ez azt jelenti, hogy <strong>0.1mm vastagságnövelés többet számít, mint 5-10mm profil magasságnövelés</strong>.
          </p>
          <div class="math-example">
            <div class="math-row">
              <span class="math-label">0.4mm köbe:</span>
              <span class="math-value">0.4³ = 0.064</span>
            </div>
            <div class="math-row">
              <span class="math-label">0.5mm köbe:</span>
              <span class="math-value">0.5³ = 0.125 <strong>(+95%)</strong></span>
            </div>
            <div class="math-row">
              <span class="math-label">0.6mm köbe:</span>
              <span class="math-value">0.6³ = 0.216 <strong>(+238%)</strong></span>
            </div>
          </div>
          <p>
            A T18 profil alaktényezője (1.08) tovább növeli a szorzót. Ezért a <strong>T18 0.5mm-ünk 208%-os erősséget ér el</strong>, vagyis több mint kétszer erősebb, mint a leggyengébb piaci T12 0.4mm.
          </p>
        </div>

        <div class="explainer-baseline">
          <h4>Mi a 100%? (baseline)</h4>
          <p>A <strong>T12 0.4mm</strong> a leggyakoribb, legolcsóbb trapézlemez a piacon – ezt vettük <strong>100%-os alapértéknek</strong>. Minden más profilt ehhez viszonyítunk, Eurocode 3 (MSZ EN 1993-1-3) szabvány szerint, egyenletesen megoszló terhelésre számítva.</p>
        </div>
      </div>

      <StrengthChart />

      <ComparisonTable
        competitorName="T20 0.4mm"
        ourName="T18 0.5mm nálunk"
        rows={comparisonRows}
      />
    </div>
  </section>

  <!-- Experience Block -->
  <section class="section section--tight">
    <div class="container">
      <ExperienceBlock text="Több mint egy évtized tetőkészítői tapasztalatból tudjuk: a vastagság számít, nem a bordamagasság. A vastagság köbre emelve hat az erősségre – ezért a T18 0.5mm-ünk erősebb, mint a legtöbb versenytárs T20 vagy T25 0.4mm-es lemeze." />
    </div>
  </section>

  <!-- Trust Signals -->
  <section class="section section--tight section--alt" id="rolunk">
    <div class="container">
      <h2>Miért minket válasszon?</h2>
      <TrustSignals />
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="section section--tight" id="gyik">
    <div class="container">
      <h2>Gyakran ismételt kérdések</h2>
      <div class="faq-list">
        {faqs.map((faq) => (
          <details class="faq-item">
            <summary class="faq-question">{faq.question}</summary>
            <p class="faq-answer">{faq.answer}</p>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Bottom CTA -->
  <section class="section section--tight">
    <div class="container">
      <CtaBox />
    </div>
  </section>
</Layout>

<style>
  /* Hero */
  .hero {
    background: linear-gradient(135deg, #0e2a42 0%, #1a3d5c 100%);
    color: var(--color-white);
    padding: var(--spacing-2xl) 0;
    text-align: center;
  }

  .hero-content {
    max-width: 720px;
    margin: 0 auto;
  }

  .hero h1 {
    font-size: var(--font-size-3xl);
    margin: 0 0 var(--spacing-sm);
    line-height: 1.2;
    color: var(--color-white);
  }

  .hero-subtitle {
    font-size: var(--font-size-base);
    opacity: 0.9;
    margin: 0 0 var(--spacing-lg);
    line-height: 1.6;
  }

  .hero-ctas {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    flex-wrap: wrap;
  }

  /* USP Strip */
  .usp-strip {
    background: var(--color-bg-light);
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--color-border);
  }

  .usp-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
  }

  .usp-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-xs);
  }

  .usp-icon {
    flex-shrink: 0;
    color: var(--color-primary);
    margin-top: 2px;
  }

  .usp-text {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .usp-text strong {
    font-size: 0.85rem;
    color: var(--color-text);
  }

  .usp-text span {
    font-size: 0.75rem;
    color: var(--color-text-light);
    line-height: 1.3;
  }

  /* 0.6mm promo banner */
  .promo-banner {
    padding: var(--spacing-md) 0;
    background: #fff8e1;
    border-bottom: 1px solid #f9a825;
  }

  .promo-inner {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
  }

  .promo-badge {
    background: #f9a825;
    color: #5d4037;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    white-space: nowrap;
    text-transform: uppercase;
    flex-shrink: 0;
  }

  .promo-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .promo-content strong {
    font-size: 0.95rem;
    color: #5d4037;
  }

  .promo-content span {
    font-size: 0.8rem;
    color: #795548;
    line-height: 1.4;
  }

  .promo-content a {
    color: #5d4037;
    font-weight: 600;
  }

  /* Sections */
  .section {
    padding: var(--spacing-3xl) 0;
  }

  .section--tight {
    padding: var(--spacing-xl) 0;
  }

  .section--alt {
    background: var(--color-bg-light);
  }

  .section h2 {
    margin-bottom: var(--spacing-md);
  }

  .section-subtitle {
    color: var(--color-text-light);
    margin: 0 0 var(--spacing-lg);
    font-size: var(--font-size-sm);
  }

  /* Product Grid - 4 columns */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-md);
  }

  /* Calculator CTA */
  .calculator-cta-box {
    text-align: center;
    max-width: 520px;
    margin: 0 auto;
  }

  .calculator-cta-box h2 {
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-xl);
  }

  .calculator-cta-box p {
    color: var(--color-text-light);
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-sm);
    line-height: 1.5;
  }

  /* Strength Explainer */
  .strength-explainer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }

  .explainer-physics {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
  }

  .explainer-physics h3 {
    margin: 0 0 var(--spacing-sm);
    font-size: var(--font-size-base);
  }

  .explainer-physics p {
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--color-text-light);
    margin: 0 0 var(--spacing-sm);
  }

  .explainer-physics code {
    background: var(--color-bg-light);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
  }

  .math-example {
    background: var(--color-bg-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm) var(--spacing-md);
    margin: var(--spacing-sm) 0;
  }

  .math-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 0.85rem;
  }

  .math-label {
    color: var(--color-text-light);
  }

  .math-value {
    font-family: monospace;
    color: var(--color-text);
  }

  .explainer-baseline {
    background: #e8f5e9;
    border: 1px solid #a5d6a7;
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .explainer-baseline h4 {
    margin: 0 0 var(--spacing-sm);
    font-size: var(--font-size-base);
    color: var(--color-primary-dark);
  }

  .explainer-baseline p {
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--color-text);
    margin: 0;
  }

  /* Screw Modal */
  .screw-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
  }

  .screw-modal {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    max-width: 420px;
    width: 100%;
    position: relative;
    box-shadow: var(--shadow-lg);
  }

  .screw-modal-close {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    line-height: 1;
    padding: 4px 8px;
  }

  .screw-modal-title {
    margin: 0 0 var(--spacing-xs);
    font-size: var(--font-size-lg);
  }

  .screw-modal-desc {
    margin: 0 0 var(--spacing-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  .screw-calc {
    background: var(--color-bg-light);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
  }

  .screw-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: var(--spacing-sm);
  }

  .screw-recommendation {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-primary-dark);
  }

  .screw-price-info {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .screw-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    justify-content: center;
    margin-bottom: var(--spacing-sm);
  }

  .screw-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--color-primary);
    background: var(--color-white);
    color: var(--color-primary);
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .screw-btn:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .screw-count {
    font-size: var(--font-size-xl);
    font-weight: 700;
    min-width: 30px;
    text-align: center;
  }

  .screw-unit {
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  .screw-total {
    text-align: center;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-primary-dark);
  }

  .screw-modal-actions {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .screw-modal-actions .btn {
    width: 100%;
    text-align: center;
    justify-content: center;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-light);
    padding: 10px 20px;
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    cursor: pointer;
    font-weight: 500;
  }

  .btn-outline:hover {
    background: var(--color-bg-light);
    color: var(--color-text);
  }

  /* FAQ Section */
  .faq-list {
    max-width: 760px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .faq-item {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: box-shadow var(--transition-fast, 0.2s);
  }

  .faq-item:hover {
    box-shadow: var(--shadow-sm);
  }

  .faq-item[open] {
    box-shadow: var(--shadow-md);
  }

  .faq-question {
    padding: var(--spacing-sm) var(--spacing-md);
    font-weight: 600;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    font-size: var(--font-size-sm);
    line-height: 1.5;
  }

  .faq-question::-webkit-details-marker {
    display: none;
  }

  .faq-question::after {
    content: '+';
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--color-primary);
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .faq-item[open] .faq-question::after {
    content: '-';
  }

  .faq-answer {
    padding: 0 var(--spacing-md) var(--spacing-md);
    margin: 0;
    color: var(--color-text-light);
    line-height: 1.7;
    font-size: 0.8rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .usp-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .product-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .strength-explainer {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .hero {
      padding: var(--spacing-xl) 0;
    }

    .hero h1 {
      font-size: var(--font-size-2xl);
    }

    .hero-ctas {
      flex-direction: column;
      align-items: center;
    }

    .hero-ctas .btn {
      width: 100%;
      max-width: 320px;
      justify-content: center;
    }

    .product-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .promo-inner {
      flex-direction: column;
      gap: var(--spacing-sm);
    }
  }

  @media (max-width: 480px) {
    .usp-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
    }

    .product-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }

    .hero h1 {
      font-size: var(--font-size-xl);
    }
  }
</style>

<script>
  import { quickAddToCart, formatPrice } from '../../lib/cart';
  import { calculateScrewCost } from '../../calculator/calculation';

  // Enable/disable cart buttons based on sqm input
  document.querySelectorAll<HTMLInputElement>('.sqm-input').forEach((input) => {
    const card = input.closest('.product-card') as HTMLElement;
    const btn = card?.querySelector('.product-cart-btn') as HTMLButtonElement;
    if (!btn) return;

    input.addEventListener('input', () => {
      const val = parseFloat(input.value);
      btn.disabled = !val || val <= 0;
    });
  });

  // Screw modal state
  let pendingColorId = '';
  let pendingSqm = 0;
  let screwBoxes = 0;
  let recommendedBoxes = 0;

  const modal = document.getElementById('screw-modal') as HTMLDivElement;
  const screwCountEl = document.getElementById('screw-count') as HTMLElement;
  const screwTotalEl = document.getElementById('screw-total') as HTMLElement;
  const screwRecommendation = document.getElementById('screw-recommendation') as HTMLElement;
  const screwMinusBtn = document.getElementById('screw-minus') as HTMLButtonElement;
  const screwPlusBtn = document.getElementById('screw-plus') as HTMLButtonElement;
  const screwAddBtn = document.getElementById('screw-add-btn') as HTMLButtonElement;
  const screwSkipBtn = document.getElementById('screw-skip-btn') as HTMLButtonElement;
  const screwCloseBtn = document.getElementById('screw-modal-close') as HTMLButtonElement;

  function updateScrewDisplay() {
    screwCountEl.textContent = String(screwBoxes);
    const cost = screwBoxes * 5990;
    screwTotalEl.textContent = cost > 0 ? `Csavar összesen: ${formatPrice(cost)}` : '';
    screwAddBtn.textContent = screwBoxes > 0
      ? `Hozzáadás csavarral (${formatPrice(cost)})`
      : 'Hozzáadás csavar nélkül';
  }

  function openScrewModal(colorId: string, sqm: number) {
    pendingColorId = colorId;
    pendingSqm = sqm;
    const calc = calculateScrewCost(sqm);
    recommendedBoxes = calc.boxes;
    screwBoxes = recommendedBoxes;
    screwRecommendation.textContent = `${sqm} m²-hez ajánlott: ${recommendedBoxes} doboz (${recommendedBoxes * 250} db csavar)`;
    updateScrewDisplay();
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeScrewModal() {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }

  function finishAdd(withScrews: boolean) {
    quickAddToCart(pendingSqm, pendingColorId, withScrews);

    // If screws, also update the cart item's screw cost with the actual box count
    // (quickAddToCart calculates automatically based on sqm, which matches)
    closeScrewModal();

    // Show feedback on the card's button
    const card = document.querySelector(`[data-color-id="${pendingColorId}"]`) as HTMLElement;
    const btn = card?.querySelector('.product-cart-btn') as HTMLButtonElement;
    if (btn) {
      const origText = btn.textContent;
      btn.textContent = 'Hozzáadva!';
      btn.style.background = '#16a34a';
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = origText || 'Kosárba';
        btn.style.background = '';
        btn.disabled = false;
        // Clear the input
        const input = card.querySelector('.sqm-input') as HTMLInputElement;
        if (input) {
          input.value = '';
          btn.disabled = true;
        }
      }, 2000);
    }

    // GTM event
    if (window.dataLayer) {
      const pricePerSqm = parseInt(card?.dataset.price || '2640', 10);
      window.dataLayer.push({
        event: 'add_to_cart',
        ecommerce: {
          currency: 'HUF',
          value: Math.round(pendingSqm * pricePerSqm),
          items: [{ item_name: `T18 0.5mm - ${pendingColorId}`, quantity: pendingSqm }],
        },
      });
    }
  }

  // Cart button click -> open screw modal
  document.querySelectorAll<HTMLButtonElement>('[data-action="add-to-cart"]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.product-card') as HTMLElement;
      const input = card?.querySelector('.sqm-input') as HTMLInputElement;
      const sqm = parseFloat(input?.value || '0');
      const colorId = btn.dataset.colorId || '';
      if (!sqm || sqm <= 0 || !colorId) return;

      openScrewModal(colorId, sqm);
    });
  });

  // Screw +/- controls
  screwMinusBtn?.addEventListener('click', () => {
    if (screwBoxes > 0) {
      screwBoxes--;
      updateScrewDisplay();
    }
  });

  screwPlusBtn?.addEventListener('click', () => {
    screwBoxes++;
    updateScrewDisplay();
  });

  // Modal actions
  screwAddBtn?.addEventListener('click', () => finishAdd(screwBoxes > 0));
  screwSkipBtn?.addEventListener('click', () => {
    screwBoxes = 0;
    finishAdd(false);
  });
  screwCloseBtn?.addEventListener('click', closeScrewModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeScrewModal();
  });

  // Escape key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.style.display !== 'none') {
      closeScrewModal();
    }
  });
</script>
