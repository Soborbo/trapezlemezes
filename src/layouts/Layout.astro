---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { LCPTracker } from '../components/images';
import { getEntitySchemaGraph } from '../config/schema';

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  noindex?: boolean;
  hideHeader?: boolean;
  hideNotifications?: boolean;
  ogImage?: string;
  /** Extra JSON-LD schema (page-specific, pl. FAQ, Product) */
  extraSchema?: Record<string, unknown>;
}

const {
  title,
  description = 'Trapézlemez gyártás és értékesítés közvetlenül a gyártótól. T18 0.5mm – erősebb, olcsóbb. 48 óra gyártás, 20 év garancia.',
  canonicalUrl,
  noindex = false,
  hideHeader = false,
  hideNotifications = false,
  ogImage,
  extraSchema,
} = Astro.props;

const currentPath = Astro.url.pathname;
const siteUrl = 'https://trapezlemezes.hu';
const fullCanonicalUrl = canonicalUrl || `${siteUrl}${currentPath}`;
const entitySchema = getEntitySchemaGraph();
---

<!DOCTYPE html>
<html lang="hu">
<head>
  <!-- Google Tag Manager dataLayer initialization (must be before GTM script) -->
  <!-- Meta Pixel is loaded via GTM with consent mode - DO NOT add hardcoded pixel here -->
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  <meta name="description" content={description}>

  {noindex ? (
    <meta name="robots" content="noindex, nofollow">
  ) : (
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  )}

  <link rel="canonical" href={fullCanonicalUrl}>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:url" content={fullCanonicalUrl}>
  <meta property="og:site_name" content="Trapezlemezes.hu">
  <meta property="og:locale" content="hu_HU">
  {ogImage && <meta property="og:image" content={ogImage}>}

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  {ogImage ? <meta name="twitter:image" content={ogImage}> : <meta name="twitter:image" content={`${siteUrl}/og-image.jpg`}>}

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">

  <!-- Default OG Image -->
  {!ogImage && <meta property="og:image" content={`${siteUrl}/og-image.jpg`} />}

  <!-- Structured Data - Entity Schema Graph -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(entitySchema)} />

  {extraSchema && (
    <script is:inline type="application/ld+json" set:html={JSON.stringify(extraSchema)} />
  )}
</head>
<body>
  {!hideHeader && <Header currentPath={currentPath} />}

  <main>
    <slot />
  </main>

  <Footer />

  <LCPTracker />

  {!hideNotifications && (
    <>
      <!-- Desktop notification popup (only on desktop, after 10s) -->
      <div class="desktop-notification" id="desktop-notification">
        <button class="notification-close" id="notification-close" aria-label="Értesítés bezárása"><span aria-hidden="true">&times;</span></button>
        <div class="notification-avatar">
          <img src="/kapcsolat-avatar.jpg" alt="Kapcsolat" width="60" height="60" />
        </div>
        <div class="notification-content">
          <p class="notification-name">Farkas Roland</p>
          <p class="notification-text">Rendelni szeretne vagy csak kérdése van? Hívjon bizalommal most a <a href="tel:+3613009206">+36 1 300-92-06</a> számon!</p>
        </div>
      </div>

      <!-- Mobile floating CTA (only on mobile, after 5s) -->
      <div class="mobile-floating-cta" id="mobile-floating-cta">
        <a href="tel:+3613009206" class="floating-btn floating-call">
          Hívjon most
        </a>
        <a href="/kalkulator" class="floating-btn floating-calc">
          Online Árkalkuláció
        </a>
      </div>
    </>
  )}

  <style>
    /* Desktop notification popup */
    .desktop-notification {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, #1a3d5c 0%, #0e2a42 100%);
      border-radius: 16px;
      padding: 20px 24px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      z-index: 1000;
      max-width: 380px;
      gap: 16px;
      animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .desktop-notification.show {
      display: flex;
      align-items: flex-start;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notification-close {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: color 0.2s;
    }

    .notification-close:hover {
      color: #fff;
    }

    .notification-avatar {
      flex-shrink: 0;
    }

    .notification-avatar img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .notification-content {
      flex: 1;
    }

    .notification-name {
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      margin: 0 0 6px;
    }

    .notification-text {
      color: rgba(255,255,255,0.9);
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 0;
    }

    .notification-text a {
      color: #fbbf24;
      font-weight: 700;
      text-decoration: none;
    }

    .notification-text a:hover {
      text-decoration: underline;
    }

    /* Hide on mobile */
    @media (max-width: 768px) {
      .desktop-notification {
        display: none !important;
      }
    }

    /* Mobile floating CTA */
    .mobile-floating-cta {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      gap: 12px;
      padding: 12px 16px;
      background: #ffffff;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      z-index: 999;
      opacity: 0;
      transform: translateY(100%);
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mobile-floating-cta.show {
      opacity: 1;
      transform: translateY(0);
    }

    .floating-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.9rem;
      text-decoration: none;
      transition: transform 0.2s, opacity 0.2s;
    }

    .floating-btn:active {
      transform: scale(0.97);
    }

    .floating-call {
      background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
      color: #fff;
    }

    .floating-calc {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: #fff;
    }

    /* Show only on mobile */
    @media (max-width: 768px) {
      .mobile-floating-cta {
        display: flex;
      }
    }

    @media (min-width: 769px) {
      .mobile-floating-cta {
        display: none !important;
      }
    }
  </style>

  <script>
    // Desktop notification - show after 10 seconds
    const desktopNotification = document.getElementById('desktop-notification');
    const notificationClose = document.getElementById('notification-close');

    // Check if notification was dismissed in this session
    const notificationDismissed = sessionStorage.getItem('notificationDismissed');

    if (!notificationDismissed && window.innerWidth > 768) {
      setTimeout(() => {
        desktopNotification?.classList.add('show');
      }, 10000);
    }

    notificationClose?.addEventListener('click', () => {
      desktopNotification?.classList.remove('show');
      sessionStorage.setItem('notificationDismissed', 'true');
    });

    // Mobile floating CTA - show after 3 seconds
    const mobileFloatingCta = document.getElementById('mobile-floating-cta');
    const mobileDismissed = sessionStorage.getItem('mobileCTADismissed');

    if (!mobileDismissed && window.innerWidth <= 768) {
      setTimeout(() => {
        mobileFloatingCta?.classList.add('show');
      }, 3000);
    }

    // Phone click tracking - moved to module script below for consent import
  </script>

  <!-- Conversion tracking initialization (attribution, session, remarketing) + phone click -->
  <script>
    import('../components/conversion-tracking/src/scripts/init').catch(() => {
      // Silently fail if tracking init fails
    });

    // Phone click tracking for GTM/Google Ads call conversions + Meta
    import { trackMetaContactPixel, generateMetaEventId } from '../components/conversion-tracking/src/client/metaPixel';

    let phoneClickTracked = sessionStorage.getItem('phone_click_tracked') === 'true';

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const link = target.closest('a[href^="tel:"]') as HTMLAnchorElement;
      if (link) {
        const phoneNumber = link.href.replace('tel:', '');
        const isMobile = window.innerWidth <= 768;

        // GTM dataLayer push (always - GTM handles consent)
        if (window.dataLayer) {
          window.dataLayer.push({
            event: 'phone_click',
            phone_number: phoneNumber,
            click_location: link.className || 'unknown',
            device_type: isMobile ? 'mobile' : 'desktop'
          });
        }

        // Meta Pixel Contact event (once per session, consent-aware)
        if (!phoneClickTracked) {
          const result = trackMetaContactPixel({
            eventId: generateMetaEventId(),
            contentName: 'Phone Click'
          });
          // Mark as tracked regardless of consent (to prevent spam if consent given later)
          phoneClickTracked = true;
          sessionStorage.setItem('phone_click_tracked', 'true');
        }
      }
    });
  </script>
</body>
</html>
